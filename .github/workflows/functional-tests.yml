name: Functional Tests - WIP

permissions:
  contents: read
  packages: read

on:
  pull_request:
    branches: []
  push:
    branches: ['tests-kimia']
  workflow_dispatch:
    inputs:
      runner:
        description: 'GitHub runner to use'
        required: false
        default: 'ubuntu-latest'
        type: string
      platforms:
        description: 'Target platforms for image build'
        required: false
        default: 'linux/amd64'
        type: string
      push_images:
        description: 'Push images to registry'
        required: false
        default: true
        type: boolean

env:
  # Registry configuration
  REGISTRY: ghcr.io
  IMAGE_BASE: ${{ github.repository }}

  # Default build configuration
  DEFAULT_RUNNER: ubuntu-latest
  DEFAULT_PLATFORMS: linux/amd64

jobs:
  # ============================================================================
  # Job: Build Kimia Images
  # Builds both kimia (BuildKit) and kimia-bud (Buildah) variants
  # ============================================================================
  build-images:
    name: Build ${{ matrix.variant }}
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: kimia
            dockerfile: Dockerfile.buildkit
            image_suffix: ''
          - variant: kimia-bud
            dockerfile: Dockerfile.buildah
            image_suffix: '-bud'

    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      kimia_image: ${{ steps.meta.outputs.kimia_image }}
      kimia_bud_image: ${{ steps.meta.outputs.kimia_bud_image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Generate build metadata
        id: meta
        run: |
          # Determine image tag based on event type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
            IMAGE_TAG="pr-${{ github.event.pull_request.number }}-${SHORT_SHA}"
            BRANCH="${{ github.head_ref }}"
          else
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            IMAGE_TAG="sha-${SHORT_SHA}"
            BRANCH="${{ github.ref_name }}"
          fi

          # Set outputs
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "kimia_image=${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "kimia_bud_image=${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}-bud:${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.variant }}
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          platforms: ${{ inputs.platforms || env.DEFAULT_PLATFORMS }}
          push: ${{ github.event_name != 'workflow_dispatch' || inputs.push_images }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}${{ matrix.image_suffix }}:${{ steps.meta.outputs.image_tag }}
          build-args: |
            VERSION=${{ steps.meta.outputs.image_tag }}
            COMMIT=${{ github.sha }}
            BRANCH=${{ steps.meta.outputs.branch }}
          cache-from: type=gha,scope=${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}

      - name: Output build summary
        run: |
          echo "## Build Summary - ${{ matrix.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}${{ matrix.image_suffix }}:${{ steps.meta.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dockerfile** | \`${{ matrix.dockerfile }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platforms** | \`${{ inputs.platforms || env.DEFAULT_PLATFORMS }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ steps.meta.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job: Smoke Tests
  # Basic validation tests for built images
  # ============================================================================
  smoke-tests:
    name: Smoke Test ${{ matrix.variant }}
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    needs: build-images
    permissions:
      contents: read
      packages: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: kimia
            image_suffix: ''
          - variant: kimia-bud
            image_suffix: '-bud'

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}${{ matrix.image_suffix }}:${{ needs.build-images.outputs.image_tag }}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}${{ matrix.image_suffix }}:${{ needs.build-images.outputs.image_tag }} ${{ matrix.variant }}:test

      - name: Test ${{ matrix.variant }}
        run: |
          echo "Running smoke tests for ${{ matrix.variant }}..."

          # Test --version flag
          echo "Testing --version..."
          docker run --rm ${{ matrix.variant }}:test --version || echo "--version not available"

          # Test --help flag
          echo "Testing --help..."
          docker run --rm ${{ matrix.variant }}:test --help || echo "--help not available"

          echo "Basic tests passed for ${{ matrix.variant }}"

      - name: Output test summary
        run: |
          echo "## Smoke Test Summary - ${{ matrix.variant }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| --version | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| --help | Passed |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job: Docker Mode Tests (kimia-bud)
  # Comprehensive Docker tests with VFS and Overlay storage drivers
  # ============================================================================
  docker-tests-bud:
    name: Docker Tests - kimia-bud (${{ matrix.storage }})
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    needs: build-images
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        storage: [vfs, overlay]

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull kimia-bud image
        run: |
          docker pull ${{ needs.build-images.outputs.kimia_bud_image }}

      - name: Setup overlay volume (overlay only)
        if: matrix.storage == 'overlay'
        run: |
          mkdir -p /tmp/kimia-buildah-overlay
          sudo chown 1000:1000 /tmp/kimia-buildah-overlay

      - name: Test 1 - Version check
        run: |
          echo "=== Test 1: Version Check ==="
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            --version

      - name: Test 2a - Pre-diagnostics (Host)
        run: |
          echo "=== Test 2a: Host Environment Diagnostics ==="
          echo "Docker version:"
          docker version
          echo ""
          echo "Docker info:"
          docker info | grep -i "security\|userns"
          echo ""
          echo "Kernel version:"
          uname -a
          echo ""
          echo "User namespace support:"
          cat /proc/sys/kernel/unprivileged_userns_clone || echo "File not found"
          echo ""
          echo "Max user namespaces:"
          cat /proc/sys/user/max_user_namespaces || echo "File not found"

      - name: Test 2b - Diagnostics (Container without caps)
        run: |
          echo "=== Test 2b: Container Diagnostics (without caps) ==="
          docker run --rm --user 1000:1000 --entrypoint="" \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            sh -c 'echo "NoNewPrivs:" && cat /proc/self/status | grep NoNewPrivs || true; \
                   echo "Capabilities:" && cat /proc/self/status | grep Cap || true'

      - name: Test 2c - Diagnostics (Container with caps)
        run: |
          echo "=== Test 2c: Container Diagnostics (with caps) ==="
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            --entrypoint="" \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            sh -c 'echo "NoNewPrivs:" && cat /proc/self/status | grep NoNewPrivs || true; \
                   echo "" && echo "Capabilities:" && cat /proc/self/status | grep Cap || true; \
                   echo "" && echo "Testing unshare:" && unshare --user --pid --map-root-user echo "Success" 2>&1 || echo "Failed: exit code $?"; \
                   echo "" && echo "Checking /proc/sys/kernel/unprivileged_userns_clone:" && cat /proc/sys/kernel/unprivileged_userns_clone 2>&1 || echo "File not found"'

      - name: Test 2d - Check userns_mode
        run: |
          echo "=== Test 2d: Testing with userns-mode=host ==="
          docker run --rm \
            --userns=host \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            --entrypoint="" \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            sh -c 'echo "Testing unshare with userns=host:" && unshare --user --pid --map-root-user echo "Success" 2>&1 || echo "Failed: exit code $?"'       

      - name: Test 2 - Environment check
        run: |
          echo "=== Test 2: Environment Check ==="
          VOLUME_OPTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUME_OPTS="-v /tmp/kimia-buildah-overlay:/home/kimia/.local --cap-add DAC_OVERRIDE --cap-add MKNOD"
          fi

          # Run check but don't fail the workflow - we want to see the diagnostics
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            $VOLUME_OPTS \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            check-environment --storage-driver=${{ matrix.storage }} || \
            echo "::warning::Environment check failed with exit code $? - this may be a GitHub Actions limitation"

      - name: Test 3 - Git build (nginx)
        run: |
          echo "=== Test 3: Git Build - nginx ==="
          VOLUME_OPTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUME_OPTS="-v /tmp/kimia-buildah-overlay:/home/kimia/.local"
          fi
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --cap-add DAC_OVERRIDE \
            --cap-add MKNOD \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            $VOLUME_OPTS \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            --context=https://github.com/nginxinc/docker-nginx.git \
            --git-branch=master \
            --dockerfile=mainline/alpine/Dockerfile \
            --destination=${{ env.REGISTRY }}/buildah-rootless-nginx-${{ matrix.storage }}:latest \
            --storage-driver=${{ matrix.storage }} \
            --insecure \
            --no-push \
            --verbosity=debug

      - name: Test 4 - HTTPS alpine with context sub-path
        run: |
          echo "=== Test 4: HTTPS Alpine with Context Sub-path ==="
          VOLUME_OPTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUME_OPTS="-v /tmp/kimia-buildah-overlay:/home/kimia/.local"
          fi
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --cap-add DAC_OVERRIDE \
            --cap-add MKNOD \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            $VOLUME_OPTS \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            --context=https://github.com/alpinelinux/docker-alpine.git \
            --context-sub-path="" \
            --dockerfile=Dockerfile \
            --destination=${{ env.REGISTRY }}/buildah-rootless-sub-path-alpine-${{ matrix.storage }}:latest \
            --storage-driver=${{ matrix.storage }} \
            --insecure \
            --no-push \
            --verbosity=debug

      - name: Test 5 - Git alpine with context sub-path
        run: |
          echo "=== Test 5: Git Alpine with Context Sub-path ==="
          VOLUME_OPTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUME_OPTS="-v /tmp/kimia-buildah-overlay:/home/kimia/.local"
          fi
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --cap-add DAC_OVERRIDE \
            --cap-add MKNOD \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            $VOLUME_OPTS \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            --context=git://github.com/alpinelinux/docker-alpine.git \
            --context-sub-path="" \
            --dockerfile=Dockerfile \
            --destination=${{ env.REGISTRY }}/buildah-rootless-git-alpine-${{ matrix.storage }}:latest \
            --storage-driver=${{ matrix.storage }} \
            --insecure \
            --no-push \
            --verbosity=debug

      - name: Test 6 - Reproducible build 1
        run: |
          echo "=== Test 6: Reproducible Build #1 ==="
          VOLUME_OPTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUME_OPTS="-v /tmp/kimia-buildah-overlay:/home/kimia/.local"
          fi
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --cap-add DAC_OVERRIDE \
            --cap-add MKNOD \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            $VOLUME_OPTS \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            --context=https://github.com/rapidfort/kimia.git \
            --git-branch=main \
            --dockerfile=tests/examples/Dockerfile \
            --destination=${{ env.REGISTRY }}/buildah-reproducible-test-${{ matrix.storage }}:v1 \
            --storage-driver=${{ matrix.storage }} \
            --reproducible \
            --insecure \
            --no-push \
            --verbosity=debug

      - name: Test 7 - Reproducible build 2
        run: |
          echo "=== Test 7: Reproducible Build #2 ==="
          sleep 2
          VOLUME_OPTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUME_OPTS="-v /tmp/kimia-buildah-overlay:/home/kimia/.local"
          fi
          docker run --rm \
            --user 1000:1000 \
            --cap-add SETUID \
            --cap-add SETGID \
            --cap-add DAC_OVERRIDE \
            --cap-add MKNOD \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            $VOLUME_OPTS \
            ${{ needs.build-images.outputs.kimia_bud_image }} \
            --context=https://github.com/rapidfort/kimia.git \
            --git-branch=main \
            --dockerfile=tests/examples/Dockerfile \
            --destination=${{ env.REGISTRY }}/buildah-reproducible-test-${{ matrix.storage }}:v2 \
            --storage-driver=${{ matrix.storage }} \
            --reproducible \
            --insecure \
            --no-push \
            --verbosity=debug

      - name: Test 8 - Compare reproducible builds
        run: |
          echo "=== Test 8: Compare Reproducible Builds ==="
          docker pull ${{ env.REGISTRY }}/buildah-reproducible-test-${{ matrix.storage }}:v1 || true
          docker pull ${{ env.REGISTRY }}/buildah-reproducible-test-${{ matrix.storage }}:v2 || true

          DIGEST1=$(docker inspect ${{ env.REGISTRY }}/buildah-reproducible-test-${{ matrix.storage }}:v1 --format='{{index .RepoDigests 0}}' 2>/dev/null | cut -d'@' -f2 || echo "none")
          DIGEST2=$(docker inspect ${{ env.REGISTRY }}/buildah-reproducible-test-${{ matrix.storage }}:v2 --format='{{index .RepoDigests 0}}' 2>/dev/null | cut -d'@' -f2 || echo "none")

          echo "Build 1 digest: $DIGEST1"
          echo "Build 2 digest: $DIGEST2"

          if [ "$DIGEST1" = "$DIGEST2" ] && [ "$DIGEST1" != "none" ]; then
            echo "SUCCESS: Builds are reproducible!"
          else
            echo "WARNING: Builds may not be reproducible (digests differ or unavailable)"
          fi

      - name: Output test summary
        if: always()
        run: |
          echo "## Docker Tests - kimia-bud (${{ matrix.storage }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Version check |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Environment check |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Git build (nginx) |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | HTTPS alpine with context sub-path |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Git alpine with context sub-path |" >> $GITHUB_STEP_SUMMARY
          echo "| 6-8 | Reproducible builds comparison |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Storage Driver:** ${{ matrix.storage }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job: Kubernetes Mode Tests (kimia-bud)
  # Comprehensive K8s tests with VFS and Overlay storage drivers
  # ============================================================================
  k8s-tests-bud:
    name: K8s Tests - kimia-bud (${{ matrix.storage }})
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    needs: build-images
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        storage: [vfs, overlay]

    env:
      NAMESPACE: kimia-test-${{ matrix.storage }}

    steps:
      - name: Set up kind cluster
        uses: helm/kind-action@a1b0e391336a6ee6713a0583f8c6240d70863de3 # v1.12.0
        with:
          cluster_name: kimia-test-${{ matrix.storage }}

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and load image into kind
        run: |
          docker pull ${{ needs.build-images.outputs.kimia_bud_image }}
          kind load docker-image ${{ needs.build-images.outputs.kimia_bud_image }} --name kimia-test-${{ matrix.storage }}

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }}

      - name: Test 1 - Version check
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
        run: |
          echo "=== K8s Test 1: Version Check ==="
          cat << EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-version
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 60
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true
                  fsGroup: 1000
                containers:
                - name: kimia
                  image: ${KIMIA_IMAGE}
                  imagePullPolicy: Never
                  args: ["--version"]
                  securityContext:
                    runAsUser: 1000
                    runAsGroup: 1000
                    runAsNonRoot: true
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
                    seccompProfile:
                      type: Unconfined
                    appArmorProfile:
                      type: Unconfined
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
          EOF
          kubectl wait --for=condition=complete --timeout=1800s job/test-version -n ${{ env.NAMESPACE }}
          kubectl logs -l job-name=test-version -n ${{ env.NAMESPACE }}

      # - name: Test 2 - Environment check (VFS)
      #   if: matrix.storage == 'vfs'
      #   env:
      #     NAMESPACE: ${{ env.NAMESPACE }}
      #     KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
      #   run: |
      #     echo "=== K8s Test 2: Environment Check (VFS) ==="
      #     cat << EOF | kubectl apply -f -
      #     apiVersion: batch/v1
      #     kind: Job
      #     metadata:
      #       name: test-envcheck
      #       namespace: ${NAMESPACE}
      #     spec:
      #       ttlSecondsAfterFinished: 60
      #       backoffLimit: 0
      #       template:
      #         spec:
      #           restartPolicy: Never
      #           securityContext:
      #             runAsUser: 1000
      #             runAsGroup: 1000
      #             runAsNonRoot: true
      #             fsGroup: 1000
      #           containers:
      #           - name: kimia
      #             image: ${KIMIA_IMAGE}
      #             imagePullPolicy: Never
      #             args: ["check-environment", "--storage-driver=vfs"]
      #             securityContext:
      #               runAsUser: 1000
      #               runAsGroup: 1000
      #               runAsNonRoot: true
      #               allowPrivilegeEscalation: true
      #               capabilities:
      #                 drop: [ALL]
      #                 add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
      #               seccompProfile:
      #                 type: Unconfined
      #               appArmorProfile:
      #                 type: Unconfined
      #             resources:
      #               requests:
      #                 memory: "512Mi"
      #                 cpu: "500m"
      #               limits:
      #                 memory: "2Gi"
      #                 cpu: "2000m"
      #     EOF
      #     kubectl wait --for=condition=complete --timeout=1800s job/test-envcheck -n ${{ env.NAMESPACE }}
      #     kubectl logs -l job-name=test-envcheck -n ${{ env.NAMESPACE }}

      # - name: Test 2 - Environment check (Overlay)
      #   if: matrix.storage == 'overlay'
      #   env:
      #     NAMESPACE: ${{ env.NAMESPACE }}
      #     KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
      #   run: |
      #     echo "=== K8s Test 2: Environment Check (Overlay) ==="
      #     cat << EOF | kubectl apply -f -
      #     apiVersion: batch/v1
      #     kind: Job
      #     metadata:
      #       name: test-envcheck
      #       namespace: ${NAMESPACE}
      #     spec:
      #       ttlSecondsAfterFinished: 60
      #       backoffLimit: 0
      #       template:
      #         spec:
      #           restartPolicy: Never
      #           securityContext:
      #             runAsUser: 1000
      #             runAsGroup: 1000
      #             runAsNonRoot: true
      #             fsGroup: 1000
      #           containers:
      #           - name: kimia
      #             image: ${KIMIA_IMAGE}
      #             imagePullPolicy: Never
      #             args: ["check-environment", "--storage-driver=overlay"]
      #             securityContext:
      #               runAsUser: 1000
      #               runAsGroup: 1000
      #               runAsNonRoot: true
      #               allowPrivilegeEscalation: true
      #               capabilities:
      #                 drop: [ALL]
      #                 add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
      #               seccompProfile:
      #                 type: Unconfined
      #               appArmorProfile:
      #                 type: Unconfined
      #             volumeMounts:
      #               - name: kimia-local
      #                 mountPath: /home/kimia/.local
      #             resources:
      #               requests:
      #                 memory: "512Mi"
      #                 cpu: "500m"
      #               limits:
      #                 memory: "2Gi"
      #                 cpu: "2000m"
      #           volumes:
      #             - name: kimia-local
      #               emptyDir: {}
      #     EOF
      #     kubectl wait --for=condition=complete --timeout=1800s job/test-envcheck -n ${{ env.NAMESPACE }}
      #     kubectl logs -l job-name=test-envcheck -n ${{ env.NAMESPACE }}

      - name: Test 3 - Git build (no push)
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
        run: |
          echo "=== K8s Test 3: Git Build (no push) ==="
          VOLUMES=""; VOLUME_MOUNTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUMES="volumes:
                - name: kimia-local
                  emptyDir: {}"
            VOLUME_MOUNTS="volumeMounts:
                    - name: kimia-local
                      mountPath: /home/kimia/.local"
          fi
          cat << EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-git-build
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 60
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true
                  fsGroup: 1000
                containers:
                - name: kimia
                  image: ${KIMIA_IMAGE}
                  imagePullPolicy: Never
                  args:
                    - "--context=https://github.com/nginxinc/docker-nginx.git"
                    - "--git-branch=master"
                    - "--dockerfile=mainline/alpine/Dockerfile"
                    - "--destination=test-buildah-k8s-rootless-git-${{ matrix.storage }}:latest"
                    - "--storage-driver=${{ matrix.storage }}"
                    - "--no-push"
                    - "--verbosity=debug"
                  securityContext:
                    runAsUser: 1000
                    runAsGroup: 1000
                    runAsNonRoot: true
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
                    seccompProfile:
                      type: Unconfined
                    appArmorProfile:
                      type: Unconfined
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
                  ${VOLUME_MOUNTS}
                ${VOLUMES}
          EOF

          # Wait with error handling
          if kubectl wait --for=condition=complete --timeout=1800s job/test-git-build -n ${{ env.NAMESPACE }}; then
            kubectl logs -l job-name=test-git-build -n ${{ env.NAMESPACE }} --tail=100
          else
            echo "Job timed out or failed. Gathering diagnostics..."
            kubectl get pods -l job-name=test-git-build -n ${{ env.NAMESPACE }} -o wide
            kubectl logs -l job-name=test-git-build -n ${{ env.NAMESPACE }} --tail=500 --all-containers=true || echo "Could not retrieve logs"
            exit 1
          fi

      - name: Test 4 - Build with arguments (no push)
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
        run: |
          echo "=== K8s Test 4: Build with Arguments (no push) ==="
          VOLUMES=""; VOLUME_MOUNTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUMES="volumes:
                - name: kimia-local
                  emptyDir: {}"
            VOLUME_MOUNTS="volumeMounts:
                    - name: kimia-local
                      mountPath: /home/kimia/.local"
          fi
          cat << EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-buildargs
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 60
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true
                  fsGroup: 1000
                containers:
                - name: kimia
                  image: ${KIMIA_IMAGE}
                  imagePullPolicy: Never
                  args:
                    - "--context=https://github.com/nginxinc/docker-nginx.git"
                    - "--git-branch=master"
                    - "--dockerfile=mainline/alpine/Dockerfile"
                    - "--destination=test-buildah-k8s-rootless-buildargs-${{ matrix.storage }}:latest"
                    - "--build-arg=NGINX_VERSION=1.25"
                    - "--storage-driver=${{ matrix.storage }}"
                    - "--no-push"
                    - "--verbosity=debug"
                  securityContext:
                    runAsUser: 1000
                    runAsGroup: 1000
                    runAsNonRoot: true
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
                    seccompProfile:
                      type: Unconfined
                    appArmorProfile:
                      type: Unconfined
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
                  ${VOLUME_MOUNTS}
                ${VOLUMES}
          EOF

          # Wait with error handling
          if kubectl wait --for=condition=complete --timeout=1800s job/test-buildargs -n ${{ env.NAMESPACE }}; then
            kubectl logs -l job-name=test-buildargs -n ${{ env.NAMESPACE }} --tail=100
          else
            echo "Job timed out or failed. Gathering diagnostics..."
            kubectl get pods -l job-name=test-buildargs -n ${{ env.NAMESPACE }} -o wide
            kubectl logs -l job-name=test-buildargs -n ${{ env.NAMESPACE }} --tail=500 --all-containers=true || echo "Could not retrieve logs"
            exit 1
          fi

      - name: Test 5 - Git build with no push
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
        run: |
          echo "=== K8s Test 5: Git Build with Push ==="
          VOLUMES=""; VOLUME_MOUNTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUMES="volumes:
                - name: kimia-local
                  emptyDir: {}"
            VOLUME_MOUNTS="volumeMounts:
                    - name: kimia-local
                      mountPath: /home/kimia/.local"
          fi
          cat << EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-git-push
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 60
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true
                  fsGroup: 1000
                containers:
                - name: kimia
                  image: ${KIMIA_IMAGE}
                  imagePullPolicy: Never
                  args:
                    - "--context=https://github.com/nginxinc/docker-nginx.git"
                    - "--git-branch=master"
                    - "--dockerfile=mainline/alpine/Dockerfile"
                    - "--destination=${{ env.REGISTRY }}/buildah-k8s-rootless-git-${{ matrix.storage }}:latest"
                    - "--storage-driver=${{ matrix.storage }}"
                    - "--insecure"
                    - "--no-push"
                    - "--verbosity=debug"
                  securityContext:
                    runAsUser: 1000
                    runAsGroup: 1000
                    runAsNonRoot: true
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
                    seccompProfile:
                      type: Unconfined
                    appArmorProfile:
                      type: Unconfined
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
                  ${VOLUME_MOUNTS}
                ${VOLUMES}
          EOF

          # Wait with error handling
          if kubectl wait --for=condition=complete --timeout=1800s job/test-git-push -n ${{ env.NAMESPACE }}; then
            kubectl logs -l job-name=test-git-push -n ${{ env.NAMESPACE }} --tail=100
          else
            echo "Job timed out or failed. Gathering diagnostics..."
            kubectl get pods -l job-name=test-git-push -n ${{ env.NAMESPACE }} -o wide
            kubectl logs -l job-name=test-git-push -n ${{ env.NAMESPACE }} --tail=500 --all-containers=true || echo "Could not retrieve logs"
            exit 1
          fi

      - name: Test 6 - Context sub-path build
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
        run: |
          echo "=== K8s Test 6: Context Sub-path Build ==="
          VOLUMES=""; VOLUME_MOUNTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUMES="volumes:
                - name: kimia-local
                  emptyDir: {}"
            VOLUME_MOUNTS="volumeMounts:
                    - name: kimia-local
                      mountPath: /home/kimia/.local"
          fi
          cat << EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-subpath
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 60
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true
                  fsGroup: 1000
                containers:
                - name: kimia
                  image: ${KIMIA_IMAGE}
                  imagePullPolicy: Never
                  args:
                    - "--context=https://github.com/nginxinc/docker-nginx.git"
                    - "--context-sub-path=stable/alpine"
                    - "--dockerfile=Dockerfile"
                    - "--destination=${{ env.REGISTRY }}/buildah-k8s-nginx-subpath-${{ matrix.storage }}:latest"
                    - "--storage-driver=${{ matrix.storage }}"
                    - "--insecure"
                    - "--no-push"
                    - "--verbosity=debug"
                  securityContext:
                    runAsUser: 1000
                    runAsGroup: 1000
                    runAsNonRoot: true
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
                    seccompProfile:
                      type: Unconfined
                    appArmorProfile:
                      type: Unconfined
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
                  ${VOLUME_MOUNTS}
                ${VOLUMES}
          EOF

          # Wait for job with better error handling
          echo "Waiting for test-subpath job to complete (timeout: 30 minutes)..."
          if kubectl wait --for=condition=complete --timeout=1800s job/test-subpath -n ${{ env.NAMESPACE }}; then
            echo "Job completed successfully"
            kubectl logs -l job-name=test-subpath -n ${{ env.NAMESPACE }} --tail=100
          else
            echo "Job timed out or failed. Gathering diagnostics..."
            echo ""
            echo "=== Job Status ==="
            kubectl get job test-subpath -n ${{ env.NAMESPACE }} -o yaml
            echo ""
            echo "=== Pod Status ==="
            kubectl get pods -l job-name=test-subpath -n ${{ env.NAMESPACE }} -o wide
            echo ""
            echo "=== Pod Events ==="
            kubectl describe pods -l job-name=test-subpath -n ${{ env.NAMESPACE }} | grep -A 50 Events: || true
            echo ""
            echo "=== Pod Logs (all available) ==="
            kubectl logs -l job-name=test-subpath -n ${{ env.NAMESPACE }} --tail=500 --all-containers=true || echo "Could not retrieve logs"
            echo ""
            echo "=== Previous Pod Logs (if restarted) ==="
            kubectl logs -l job-name=test-subpath -n ${{ env.NAMESPACE }} --previous --tail=200 --all-containers=true || echo "No previous logs"
            exit 1
          fi

      - name: Test 7 - Reproducible build 1
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
        run: |
          echo "=== K8s Test 7: Reproducible Build #1 ==="
          VOLUMES=""; VOLUME_MOUNTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUMES="volumes:
                - name: kimia-local
                  emptyDir: {}"
            VOLUME_MOUNTS="volumeMounts:
                    - name: kimia-local
                      mountPath: /home/kimia/.local"
          fi
          cat << EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-repro-1
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 60
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true
                  fsGroup: 1000
                containers:
                - name: kimia
                  image: ${KIMIA_IMAGE}
                  imagePullPolicy: Never
                  args:
                    - "--context=https://github.com/rapidfort/kimia.git"
                    - "--git-branch=main"
                    - "--dockerfile=tests/examples/Dockerfile"
                    - "--destination=${{ env.REGISTRY }}/buildah-k8s-reproducible-test-${{ matrix.storage }}:v1"
                    - "--storage-driver=${{ matrix.storage }}"
                    - "--reproducible"
                    - "--insecure"
                    - "--no-push"
                    - "--verbosity=debug"
                  securityContext:
                    runAsUser: 1000
                    runAsGroup: 1000
                    runAsNonRoot: true
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
                    seccompProfile:
                      type: Unconfined
                    appArmorProfile:
                      type: Unconfined
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
                  ${VOLUME_MOUNTS}
                ${VOLUMES}
          EOF

          # Wait with error handling
          echo "Waiting for test-repro-1 job to complete..."
          if kubectl wait --for=condition=complete --timeout=1800s job/test-repro-1 -n ${{ env.NAMESPACE }}; then
            kubectl logs -l job-name=test-repro-1 -n ${{ env.NAMESPACE }} --tail=100
          else
            echo "Job timed out or failed. Gathering diagnostics..."
            kubectl get pods -l job-name=test-repro-1 -n ${{ env.NAMESPACE }} -o wide
            kubectl logs -l job-name=test-repro-1 -n ${{ env.NAMESPACE }} --tail=500 --all-containers=true || echo "Could not retrieve logs"
            exit 1
          fi

      - name: Test 8 - Reproducible build 2
        env:
          NAMESPACE: ${{ env.NAMESPACE }}
          KIMIA_IMAGE: ${{ needs.build-images.outputs.kimia_bud_image }}
        run: |
          echo "=== K8s Test 8: Reproducible Build #2 ==="
          sleep 5
          VOLUMES=""; VOLUME_MOUNTS=""
          if [ "${{ matrix.storage }}" = "overlay" ]; then
            VOLUMES="volumes:
                - name: kimia-local
                  emptyDir: {}"
            VOLUME_MOUNTS="volumeMounts:
                    - name: kimia-local
                      mountPath: /home/kimia/.local"
          fi
          cat << EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: test-repro-2
            namespace: ${NAMESPACE}
          spec:
            ttlSecondsAfterFinished: 60
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true
                  fsGroup: 1000
                containers:
                - name: kimia
                  image: ${KIMIA_IMAGE}
                  imagePullPolicy: Never
                  args:
                    - "--context=https://github.com/rapidfort/kimia.git"
                    - "--git-branch=main"
                    - "--dockerfile=tests/examples/Dockerfile"
                    - "--destination=${{ env.REGISTRY }}/buildah-k8s-reproducible-test-${{ matrix.storage }}:v2"
                    - "--storage-driver=${{ matrix.storage }}"
                    - "--reproducible"
                    - "--insecure"
                    - "--no-push"
                    - "--verbosity=debug"
                  securityContext:
                    runAsUser: 1000
                    runAsGroup: 1000
                    runAsNonRoot: true
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [SETUID, SETGID, DAC_OVERRIDE, MKNOD]
                    seccompProfile:
                      type: Unconfined
                    appArmorProfile:
                      type: Unconfined
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
                  ${VOLUME_MOUNTS}
                ${VOLUMES}
          EOF

          # Wait with error handling
          echo "Waiting for test-repro-2 job to complete..."
          if kubectl wait --for=condition=complete --timeout=1800s job/test-repro-2 -n ${{ env.NAMESPACE }}; then
            kubectl logs -l job-name=test-repro-2 -n ${{ env.NAMESPACE }} --tail=100
          else
            echo "Job timed out or failed. Gathering diagnostics..."
            kubectl get pods -l job-name=test-repro-2 -n ${{ env.NAMESPACE }} -o wide
            kubectl logs -l job-name=test-repro-2 -n ${{ env.NAMESPACE }} --tail=500 --all-containers=true || echo "Could not retrieve logs"
            exit 1
          fi

      - name: Get all job logs
        if: always()
        run: |
          echo "=== All Job Statuses ==="
          kubectl get jobs -n ${{ env.NAMESPACE }} -o wide
          echo ""
          echo "=== Failed Job Details ==="
          for job in $(kubectl get jobs -n ${{ env.NAMESPACE }} -o jsonpath='{.items[?(@.status.failed)].metadata.name}'); do
            echo "--- Job: $job ---"
            kubectl describe job $job -n ${{ env.NAMESPACE }}
            kubectl logs -l job-name=$job -n ${{ env.NAMESPACE }} --tail=200
          done

      - name: Output test summary
        if: always()
        run: |
          echo "## K8s Tests - kimia-bud (${{ matrix.storage }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Version check |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Environment check |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Git build (no push) |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Build with arguments (no push) |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Git build with push |" >> $GITHUB_STEP_SUMMARY
          echo "| 6 | Context sub-path build |" >> $GITHUB_STEP_SUMMARY
          echo "| 7-8 | Reproducible builds |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Storage Driver:** ${{ matrix.storage }}" >> $GITHUB_STEP_SUMMARY
          echo "**K8s Cluster:** kind (local)" >> $GITHUB_STEP_SUMMARY