name: Unit Tests - WIP

on:
  pull_request:
    branches: []
  push:
    branches: ['tests-kimia', 'unit-tests']

jobs:
  # Run Go unit tests across all packages
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: src/go.sum

      - name: Download dependencies
        working-directory: src
        run: go mod download

      - name: Run unit tests with coverage
        working-directory: src
        run: |
          echo "ðŸ§ª Running unit tests across all packages..."

          # Run tests with coverage and verbose output
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./... 2>&1 | tee test-output.txt

          # Check exit code
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          # Generate coverage report
          echo ""
          echo "ðŸ“Š Coverage Report:"
          go tool cover -func=coverage.out | tail -20

          # Extract total coverage
          TOTAL_COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo ""
          echo "ðŸ“ˆ Total Coverage: $TOTAL_COVERAGE"

          exit $TEST_EXIT_CODE

      - name: Generate coverage HTML report
        if: always()
        working-directory: src
        run: |
          if [ -f coverage.out ]; then
            go tool cover -html=coverage.out -o coverage.html
            echo "âœ… Coverage HTML report generated"
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            src/coverage.out
            src/coverage.html
          retention-days: 7

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: src/test-output.txt
          retention-days: 7

      - name: Generate test summary
        if: always()
        working-directory: src
        run: |
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count test results
          if [ -f test-output.txt ]; then
            PASSED=$(grep -c "^--- PASS" test-output.txt || echo "0")
            FAILED=$(grep -c "^--- FAIL" test-output.txt || echo "0")
            SKIPPED=$(grep -c "^--- SKIP" test-output.txt || echo "0")

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Add coverage info
          if [ -f coverage.out ]; then
            TOTAL_COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
            echo "### ðŸ“Š Code Coverage: $TOTAL_COVERAGE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Coverage by package</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          # List failed tests if any
          if [ -f test-output.txt ] && grep -q "^--- FAIL" test-output.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "^--- FAIL" test-output.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  build-test:
    runs-on: ubuntu-latest
    needs: unit-tests

    strategy:
      matrix:
        include:
          - image_name: kimia
            dockerfile: Dockerfile.buildkit
            description: "Kimia (BuildKit)"
          - image_name: kimia-bud
            dockerfile: Dockerfile.buildah
            description: "Kimia-Bud (Buildah)"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.description }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          push: false
          load: true
          tags: ${{ matrix.image_name }}:test
          cache-from: type=gha,scope=${{ matrix.image_name }}-test
          cache-to: type=gha,mode=max,scope=${{ matrix.image_name }}-test

      - name: Test ${{ matrix.description }}
        run: |
          echo "ðŸ§ª Running smoke tests for ${{ matrix.image_name }}..."
          
          # Test --version flag
          echo "Testing --version..."
          docker run --rm ${{ matrix.image_name }}:test --version || echo "âš ï¸  --version not available"
          
          # Test --help flag
          echo "Testing --help..."
          docker run --rm ${{ matrix.image_name }}:test --help || echo "âš ï¸  --help not available"
          
          echo "âœ… Basic tests passed for ${{ matrix.image_name }}"

      - name: Inspect ${{ matrix.description }}
        run: |
          echo "ðŸ“¦ Image details for ${{ matrix.image_name }}:"
          
          SIZE=$(docker image inspect ${{ matrix.image_name }}:test --format '{{.Size}}')
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          echo "  Size: ${SIZE_MB} MB"
          
          ARCH=$(docker image inspect ${{ matrix.image_name }}:test --format '{{.Architecture}}')
          echo "  Architecture: ${ARCH}"
          
          OS=$(docker image inspect ${{ matrix.image_name }}:test --format '{{.Os}}')
          echo "  OS: ${OS}"
          
          CREATED=$(docker image inspect ${{ matrix.image_name }}:test --format '{{.Created}}')
          echo "  Created: ${CREATED}"

      - name: Test build with arguments
        run: |
          echo "ðŸ§ª Testing build with custom arguments..."
          docker run --rm \
            --cap-drop ALL \
            --cap-add SETUID \
            --cap-add SETGID \
            --security-opt seccomp=unconfined \
            --security-opt apparmor=unconfined \
            ${{ matrix.image_name }}:test \
            --context=/workspace --no-push 2>&1 | head -20 || echo "âš ï¸  Build test requires full setup"

  # Integration test summary
  test-summary:
    runs-on: ubuntu-latest
    needs: [unit-tests, build-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          BUILD_STATUS="${{ needs.build-test.result }}"

          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "$UNIT_STATUS" == "success" ]]; then
            echo "| Unit Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$UNIT_STATUS" == "skipped" ]]; then
            echo "| Unit Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$BUILD_STATUS" == "success" ]]; then
            echo "| Build Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$BUILD_STATUS" == "skipped" ]]; then
            echo "| Build Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Tested" >> $GITHUB_STEP_SUMMARY
          echo "- **kimia** (BuildKit-based)" >> $GITHUB_STEP_SUMMARY
          echo "- **kimia-bud** (Buildah-based)" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Packages" >> $GITHUB_STEP_SUMMARY
          echo "- \`cmd/kimia\` - CLI argument parsing, version, help" >> $GITHUB_STEP_SUMMARY
          echo "- \`internal/auth\` - Registry authentication" >> $GITHUB_STEP_SUMMARY
          echo "- \`internal/build\` - Build execution, Git handling" >> $GITHUB_STEP_SUMMARY
          echo "- \`internal/preflight\` - Environment validation" >> $GITHUB_STEP_SUMMARY

          # Fail if unit tests or build tests failed
          if [[ "$UNIT_STATUS" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Unit tests failed - please fix before merging**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [[ "$BUILD_STATUS" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Build tests failed - please fix before merging**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
