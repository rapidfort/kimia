apiVersion: batch/v1
kind: Job
metadata:
  generateName: kaniko-repro-check-nopush
spec:
  template:
    spec:
      restartPolicy: Never
      volumes:
        - name: work
          emptyDir: { sizeLimit: "5Gi" }   # increase if your build is larger
      containers:
        - name: kaniko
          image: gcr.io/kaniko-project/executor:debug
          volumeMounts:
            - name: work
              mountPath: /workspace
          env:
            # Use the same fixed epoch for both runs
            - name: FIXED_EPOCH
              value: "1710000000"
            # Pin your repo/ref and path to the Dockerfile within the repo
            - name: GIT_CONTEXT
              value: "git://github.com/docker-library/mongo.git"
            - name: GIT_CONTEXT_SUBPATH
              value: "8.0/"
            - name: DOCKERFILE_PATH
              value: "Dockerfile"
          command: ["/busybox/sh"]
          args:
            - -c
            - |
              set -euo pipefail
              mkdir -p /workspace/out

              echo "=== Build #1 (tarPath=/workspace/out/repro1.tar)"
              /kaniko/executor \
                --context=$(GIT_CONTEXT) \
                --context-sub-path=$(GIT_CONTEXT_SUBPATH) \
                --dockerfile=$(DOCKERFILE_PATH) \
                --tarPath=/workspace/out/repro1.tar \
                --reproducible --no-push \
                --build-arg SOURCE_DATE_EPOCH=${FIXED_EPOCH}

              echo "=== Build #2 (tarPath=/workspace/out/repro2.tar)"
              /kaniko/executor \
                --context=$(GIT_CONTEXT) \
                --context-sub-path=$(GIT_CONTEXT_SUBPATH) \
                --dockerfile=$(DOCKERFILE_PATH) \
                --tarPath=/workspace/out/repro2.tar \
                --reproducible --no-push \
                --build-arg SOURCE_DATE_EPOCH=${FIXED_EPOCH}

              echo "=== Compare SHA256 of tarballs"
              sha256sum /workspace/out/repro1.tar /workspace/out/repro2.tar

              # Fail if different
              diff -q <(sha256sum /workspace/out/repro1.tar | awk '{print $1}') \
                      <(sha256sum /workspace/out/repro2.tar | awk '{print $1}')
              echo "Reproducible: tarball hashes match."

