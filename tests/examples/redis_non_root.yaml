apiVersion: batch/v1
kind: Job
metadata:
  name: redis-nonroot-build
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      # Pod-level security: non-root uid/gid 1000
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        # ------------------ Container 1: RapidFort Smithy ------------------
        # - name: smithy
        #   image: ghcr.io/rapidfort/smithy:latest
        #   imagePullPolicy: IfNotPresent
        #   # Let the image keep its ENTRYPOINT; we only add a postStart hook to log identity
        #   args:
        #     - --context=https://github.com/DHarshil/practice_app.git
        #     - --dockerfile=Dockerfile.bash
        #     - --destination=bash
        #     - --no-push
        #   securityContext:
        #     allowPrivilegeEscalation: true
        #     capabilities:
        #       drop: ["ALL"]
        #       add: ["SETUID", "SETGID"]
        #   # Print effective user/groups immediately after container starts
        #   lifecycle:
        #     postStart:
        #       exec:
        #         command:
        #           - /bin/sh
        #           - -c
        #           - |
        #             echo "=== smithy: identity check ===";
        #             id -a || true;
        #             echo "groups: $(id -Gn 2>/dev/null || echo N/A)";
        # ------------------ Container 2: Kaniko Executor ------------------
        - name: kaniko
          image: gcr.io/kaniko-project/executor:debug
          imagePullPolicy: IfNotPresent
          # Use the executor directly (no shell wrapper needed for the build),
          # but the postStart hook (below) uses /busybox/sh to print identity.
          args:
            - --context=https://github.com/DHarshil/practice_app.git
            - --dockerfile=Dockerfile.bash
            - --destination=bash
            - --no-push
            - --cleanup=false
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              drop: ["ALL"]
              add: ["SETUID", "SETGID"]
          lifecycle:
            postStart:
              exec:
                command:
                  - /busybox/sh
                  - -c
                  - |
                    echo "=== kaniko: identity check ===";
                    id -a || true;
                    echo "groups: $(id -Gn 2>/dev/null || echo N/A)";

