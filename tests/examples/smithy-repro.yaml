apiVersion: batch/v1
kind: Job
metadata:
  generateName: smithy-repro-check-nopush
spec:
  template:
    spec:
      restartPolicy: Never
      volumes:
        - name: work
          emptyDir: { sizeLimit: "5Gi" }   # increase if your build is larger
      containers:
        - name: smithy
          image: ghcr.io/rapidfort/smithy:1.0.10
          volumeMounts:
            - name: work
              mountPath: /workspace
          env:
            # Use the same fixed epoch for both runs
            - name: FIXED_EPOCH
              value: "1710000000"
            # Pin your repo/ref and path to the Dockerfile within the repo
            - name: GIT_CONTEXT
              value: "https://github.com/docker-library/mongo.git"
            - name: DOCKERFILE_PATH
              value: "Dockerfile"
            - name: GIT_CONTEXT_SUBPATH
              value: "8.0/"
          command: ["/bin/bash"]
          args:
            - -c
            - |
              set -euo pipefail
              mkdir -p /workspace/out

              echo "=== Build #1 (tarPath=/workspace/out/repro1.tar)"
              echo $(GIT_CONTEXT)
              echo $(GIT_CONTEXT_SUBPATH)
              smithy \
                --context=$(GIT_CONTEXT) \
                --context-sub-path=$(GIT_CONTEXT_SUBPATH) \
                --dockerfile=$(printf "/workspace%s" "$DOCKERFILE_PATH" | sed 's|^/workspace||') \
                --tar-path=/workspace/out/repro1.tar \
                --destination=10.228.96.114:5000/mongo_repro1 \
                --no-push \
                --build-arg SOURCE_DATE_EPOCH=${FIXED_EPOCH}

              echo "=== Build #2 (tarPath=/workspace/out/repro2.tar)"
              smithy \
                --context=$(GIT_CONTEXT) \
                --context-sub-path=$(GIT_CONTEXT_SUBPATH) \
                --dockerfile=$(printf "/workspace%s" "$DOCKERFILE_PATH" | sed 's|^/workspace||') \
                --tar-path=/workspace/out/repro2.tar \
                --destination=10.228.96.114:5000/mongo_repro2 \
                --no-push \
                --build-arg SOURCE_DATE_EPOCH=${FIXED_EPOCH}

              echo "=== Compare SHA256 of tarballs"
              sha256sum /workspace/out/repro1.tar /workspace/out/repro2.tar

              # Fail if different
              diff -q <(sha256sum /workspace/out/repro1.tar | awk '{print $1}') \
                      <(sha256sum /workspace/out/repro2.tar | awk '{print $1}')
              echo "Reproducible: tarball hashes match."

