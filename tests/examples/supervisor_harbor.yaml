apiVersion: v1
kind: ConfigMap
metadata:
  name: registries-conf
data:
  registries.conf: |
    unqualified-search-registries = ["harbor.rfinnovate.rapidfort.io","docker.io","quay.io"]

    # Mark the private registry as insecure (HTTP or self-signed TLS)
    [[registry]]
    prefix   = "harbor.rfinnovate.rapidfort.io"
    location = "harbor.rfinnovate.rapidfort.io/kimia-e2e"
    insecure = true
    blocked = false

    [[registry]]
    location = "docker.io"

    [[registry]]
    location = "quay.io"
---    
apiVersion: batch/v1
kind: Job
metadata:
  name: kimia-builds-supervisor
  labels:
    app.kubernetes.io/name: kimia-build
    app.kubernetes.io/instance: kimia-builds
    app.kubernetes.io/part-of: kimia-builds
    kimia-build/name: supervisor
spec:
  backoffLimit: 1
  ttlSecondsAfterFinished: 60
  template:
    spec:
      restartPolicy: Never
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
        - name: registries-conf
          configMap:
            name: registries-conf        
      initContainers:
        - name: build-ubuntu
          image: ghcr.io/rapidfort/kimia:1.0.21
          imagePullPolicy: Always
          env:
            - name: DOCKER_USERNAME
              value: robot$kimia_supervisor_test
            - name: DOCKER_PASSWORD
              value: 6YgfBurzt5XN6Iluzyu1nfficcyQbOM6
            - name: DOCKER_REGISTRY
              value: harbor.rfinnovate.rapidfort.io
            - name: REGISTRY_AUTH_FILE
              value: /home/kimia/.docker/config.json   
          args:
            - --context=https://github.com/dockerfile/ubuntu.git
            - --dockerfile=Dockerfile
            - --destination=harbor.rfinnovate.rapidfort.io/kimia-e2e/dockerfile/ubuntu
            - -v
          volumeMounts:
            - name: registries-conf
              mountPath: /home/kimia/.config/containers/registries.conf
              subPath: registries.conf
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              add:
              - SETUID
              - SETGID
              drop:
              - ALL

      containers:
        - name: build-supervisor
          image: ghcr.io/rapidfort/kimia:1.0.21
          imagePullPolicy: Always
          env:
            - name: DOCKER_USERNAME
              value: robot$kimia_supervisor_test
            - name: DOCKER_PASSWORD
              value: 6YgfBurzt5XN6Iluzyu1nfficcyQbOM6
            - name: DOCKER_REGISTRY
              value: harbor.rfinnovate.rapidfort.io        
            - name: REGISTRY_AUTH_FILE
              value: /home/kimia/.docker/config.json
          args:
            - --context=https://github.com/dockerfile/supervisor.git
            - --dockerfile=Dockerfile
            - --destination=harbor.rfinnovate.rapidfort.io/kimia-e2e/dockerfile/supervisor
            - -v
          volumeMounts:
            - name: registries-conf
              mountPath: /home/kimia/.config/containers/registries.conf
              subPath: registries.conf
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              add:
              - SETUID
              - SETGID
              drop:
              - ALL